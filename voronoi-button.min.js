document.addEventListener("DOMContentLoaded",(function(){VoronoiButton.isDOMContentLoaded=!0}));class VoronoiButton extends HTMLElement{static box=[[0,0],[1,0],[1,1],[0,1]];static isDOMContentLoaded=!1;constructor(){super(),this.nCells=1,this.colors=[],this.colorSelected="#FFFFFFCF",this.srcs=[],this.links=[],this.width=100,this.height=40,this.borderRadius=2,this.thresholdSim=.001,this.div=document.createElement("div"),this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.polygonList=[],this.imageList=[],this.cells,this.points=[],this.vel=[],this.mouX=0,this.mouY=0,this.isOnButton=!1,this.isChangingAttribute=!1,this.isSetAttributeInitially=!1,this.index=0,this.animate=this.animate.bind(this),this.mouseovered=this.mouseovered.bind(this),this.mouseleft=this.mouseleft.bind(this),this.mousemoved=this.mousemoved.bind(this);const shadow=this.attachShadow({mode:"open"});for(shadow.appendChild(this.div),this.div.appendChild(this.svg),this.div.style.width=this.width+"px",this.div.style.height=this.height+"px",this.div.style.overflow="hidden",this.div.style.borderRadius=this.borderRadius+"px",this.svg.style.width="100%",this.svg.style.height="100%",this.svg.addEventListener("mouseover",this.mouseovered),this.svg.addEventListener("mouseleave",this.mouseleft),this.svg.addEventListener("mousemove",this.mousemoved);this.polygonList.length<this.nCells;)this.createElements();requestAnimationFrame(this.animate)}attributeChangedCallback(name,oldValue,newValue){if(this.isChangingAttribute=!0,"n-cells"===name){for(this.nCells=newValue,this.resetVoronoiData();this.polygonList.length>this.nCells;)this.removeElements();for(;this.polygonList.length<this.nCells;)this.createElements(),this.setAttributes(this.polygonList.length-1)}else if("colors"===name){this.colors=newValue.replace(" ","").split(",");for(let i=0;i<this.nCells;i++)this.polygonList[i].setAttributeNS("http://www.w3.org/1999/xlink","href",this.colors[i%this.colors.length])}else if("color-selected"===name)this.colorSelected=newValue;else if("srcs"===name){this.srcs=newValue.replace(" ","").split(",");for(let i=0;i<this.nCells;i++)this.imageList[i].setAttributeNS("http://www.w3.org/1999/xlink","href",this.srcs[i%this.srcs.length])}else"width"===name?(this.width=newValue,this.div.style.width=this.width+"px"):"height"===name?(this.height=newValue,this.div.style.height=this.height+"px"):"border-radius"===name?(this.borderRadius=newValue,this.div.style.borderRadius=this.borderRadius+"px"):"threshold-sim"===name&&(this.thresholdSim=newValue);this.isChangingAttribute=!1}mouseovered(){this.isOnButton=!0}mouseleft(){for(let i=0;i<this.nCells;i++)this.polygonList[i].setAttribute("fill",this.colors[i%this.colors.length]);this.isOnButton=!1}mousemoved(e){const rect=e.target.getBoundingClientRect();if(this.mouX=e.clientX-rect.left,this.mouY=e.clientY-rect.top,this.isOnButton)for(let i=0;i<this.nCells;i++)isInside([this.mouX/this.width,this.mouY/this.height],this.cells[i])?(this.polygonList[i].setAttribute("fill",this.colorSelected),this.index=i):this.polygonList[i].setAttribute("fill",this.colors[i%this.colors.length])}animate(){if(VoronoiButton.isDOMContentLoaded&&!this.isSetAttributeInitially&&!this.isChangingAttribute){this.resetVoronoiData();for(let i=0;i<this.nCells;i++)this.setAttributes(i),this.setClipPath(i);this.isSetAttributeInitially=!0}if(VoronoiButton.isDOMContentLoaded&&!this.isChangingAttribute){let totalSpeed=0;for(let i=0;i<this.nCells;i++)totalSpeed+=(this.vel[i][0]**2+this.vel[i][1]**2)**.5;if(totalSpeed>this.thresholdSim){physicalSimulation(this.points,this.vel),handlePointsOutOfRange(this.points),this.cells=calcCells(this.points,VoronoiButton.box);for(let i=0;i<this.nCells;i++)this.setClipPath(i)}}requestAnimationFrame(this.animate)}setClipPath(i){let clipPathText="";for(let j=0;j<this.cells[i].length;j++)clipPathText+=`${this.cells[i][j][0]*this.width}px ${this.cells[i][j][1]*this.height}px`,j!=this.cells[i].length-1&&(clipPathText+=", "),this.imageList[i].setAttribute("style",`clip-path: polygon(${clipPathText});`),this.polygonList[i].setAttribute("style",`clip-path: polygon(${clipPathText});`)}setAttributes(i){this.imageList[i].setAttributeNS("http://www.w3.org/1999/xlink","href",this.srcs[i%this.srcs.length]),this.imageList[i].style.pointerEvents="none",this.polygonList[i].setAttribute("points",`0,0 0,${this.height} ${this.width},${this.height} ${this.width},0`),this.polygonList[i].setAttribute("fill",this.colors[i%this.colors.length])}createElements(){const image=document.createElementNS("http://www.w3.org/2000/svg","image");this.imageList.push(image),this.svg.appendChild(image);const polygon=document.createElementNS("http://www.w3.org/2000/svg","polygon");this.polygonList.push(polygon),this.svg.appendChild(polygon)}removeElements(){const polygon=this.polygonList.pop(),image=this.imageList.pop();this.svg.removeChild(polygon),this.svg.removeChild(image)}resetVoronoiData(){let points=[],vel=[];for(let i=0;i<this.nCells;i++)points.push([math.random(),math.random()]),vel.push([math.random(),math.random()]);this.points=points,this.vel=vel,this.cells=calcCells(this.points,VoronoiButton.box)}}function ortho(p){return[p[1],-p[0]]}function normalize(v){return math.divide(v,math.norm(v))}function cross2d(v0,v1){return v0[0]*v1[1]-v0[1]*v1[0]}function getDir(points){let dir=[],l=points.length;for(let i=0;i<l;i++){let d=normalize(math.subtract(points[math.mod(i+1,l)],points[i]));dir.push(d)}return dir}function getScale(points){let sca=[],l=points.length;for(let i=0;i<l;i++){let s=math.norm(math.subtract(points[math.mod(i+1,l)],points[i]));sca.push(s)}return sca}function getIntersectionCoef(p0,p1,v0,v1){return cross2d(math.subtract(p1,p0),v1)/cross2d(v0,v1)}function getIntersection(p0,p1,v0,v1){return math.add(p0,math.multiply(getIntersectionCoef(p0,p1,v0,v1),v0))}function getBisectorPoint(p0,p1){return math.divide(math.add(p0,p1),2)}function getBisectorDir(p0,p1){return ortho(normalize(math.subtract(p1,p0)))}function isInside(p,cell){let pointSide=!0,isChanged=!1,l=cell.length;for(let i=0;i<l;i++){let vec_to_p=math.subtract(p,cell[i]),vec_edge,sideBool=cross2d(getDir(cell)[i],vec_to_p)<0;0==i&&(pointSide=sideBool),pointSide!=sideBool&&(isChanged=!0,pointSide=sideBool)}return!isChanged}function calcIntersects(cell,p,q){let cellDirs=getDir(cell),cellScales=getScale(cell),bi=getBisectorPoint(p,q),biDir=getBisectorDir(p,q),count=0,indices=[],l=cell.length;for(let i=0;i<l;i++){let coef=getIntersectionCoef(cell[i],bi,cellDirs[i],biDir);coef>=0&&coef<cellScales[i]&&(count+=1,indices.push(i))}return[count,indices]}function divideCell(cell,newPoints,indices){let newCells=[[],[]],currentCell=0,l=cell.length;for(let i=0;i<l;i++)newCells[currentCell].push(cell[i]),i==indices[0]&&(newCells[0].push(newPoints[0]),newCells[1].push(newPoints[0]),currentCell=1),i==indices[1]&&(newCells[0].push(newPoints[1]),newCells[1].push(newPoints[1]),currentCell=0);return newCells}function updateCell(indices,cell,p,q){let cellDirs=getDir(cell),bi=getBisectorPoint(p,q),biDir=getBisectorDir(p,q),newPoints=[];for(let i of indices)newPoints.push(getIntersection(cell[i],bi,cellDirs[i],biDir));let newCells=divideCell(cell,newPoints,indices);return isInside(p,newCells[0])?newCells[0]:newCells[1]}function calcCells(points,cellInput){let cells=[],l=points.length;for(let iP=0;iP<l;iP++){let p=points[iP],cell=[...cellInput];for(let iQ=0;iQ<l;iQ++)if(iP!=iQ){let q=points[iQ],res=calcIntersects(cell,p,q);2==res[0]&&(cell=updateCell(res[1],cell,p,q))}cells.push(cell)}return cells}function closeConvex(pointsInput){let points=[...pointsInput];return points.push(points[0]),points}function listRound(list,digit){res=[];for(let i=0;i<list.length;i++)res.push(math.round(list[i],digit));return res}function physicalSimulation(points,vel){for(let i=0;i<points.length;i++){let acc1_=[0,0];for(let j=0;j<points.length;j++)if(i!=j){let acc1j_diff=math.subtract(points[i],points[j]),acc1j_mag=1e-4/math.norm(acc1j_diff)**2,acc1j_dir=normalize(acc1j_diff);acc1_=math.add(acc1_,math.multiply(acc1j_mag,acc1j_dir))}let acc2_=math.multiply(-1,vel[i]),acc3_=math.multiply(.01,math.subtract([.5,.5],points[i])),acc=[0,0];acc[0]+=acc1_[0]+acc2_[0]+acc3_[0],acc[1]+=acc1_[1]+acc2_[1]+acc3_[1],vel[i]=math.add(vel[i],acc),points[i]=math.add(points[i],vel[i])}}function handlePointsOutOfRange(points){for(let i=1;i<points.length;i++)points[i][0]<0&&(points[i][0]=1),points[i][0]>1&&(points[i][0]=0),points[i][1]<0&&(points[i][1]=1),points[i][1]>1&&(points[i][1]=0)}VoronoiButton.observedAttributes=["n-cells","colors","color-selected","srcs","width","height","border-radius","threshold-sim"],customElements.define("voronoi-button",VoronoiButton);